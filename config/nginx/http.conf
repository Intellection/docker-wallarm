http {
  include /etc/nginx/mime.types;
  include /etc/nginx/log.conf;

  aio                       threads;
  aio_write                 on;

  tcp_nopush                on;
  tcp_nodelay               on;

  client_body_timeout       60s;
  client_header_timeout     60s;
  keepalive_timeout         75s;
  proxy_connect_timeout     5s;
  proxy_read_timeout        60s;
  proxy_send_timeout        60s;
  send_timeout              60s;

  reset_timedout_connection on;

  port_in_redirect          off;
  server_tokens             off;

  # If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the
  # scheme used to connect to this server
  map $http_x_forwarded_proto $proxy_x_forwarded_proto {
    default $http_x_forwarded_proto;
    ''      $scheme;
  }

  # If we receive X-Forwarded-Proto, use it to determine the value of
  # X-Forwarded-Ssl
  map $http_x_forwarded_proto $proxy_x_forwarded_ssl {
    default off;
    https   on;
  }

  # If we receive X-Forwarded-Port, pass it through; otherwise, pass along the
  # server port the client connected to
  map $http_x_forwarded_port $proxy_x_forwarded_port {
    default $http_x_forwarded_port;
    ''      $server_port;
  }

  # If we receive X-Request-ID, pass it through; otherwise, pass along the
  # request_id generated by nginx
  map $http_x_request_id $proxy_x_request_id {
    default $http_x_request_id;
    ''      $request_id;
  }

  # See https://www.nginx.com/blog/websocket-nginx
  map $http_upgrade $proxy_connection {
    default Upgrade;
    ''      '';
  }

  proxy_http_version  1.1;
  proxy_set_header    Host                $host;
  proxy_set_header    Connection          $proxy_connection;
  proxy_set_header    Upgrade             $http_upgrade;

  # Mitigate httpoxy vulnerability
  proxy_set_header    Proxy               "";

  proxy_set_header    X-Real-IP           $remote_addr;
  proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
  proxy_set_header    X-Forwarded-Proto   $proxy_x_forwarded_proto;
  proxy_set_header    X-Forwarded-Ssl     $proxy_x_forwarded_ssl;
  proxy_set_header    X-Forwarded-Port    $proxy_x_forwarded_port;
  proxy_set_header    X-Request-ID        $proxy_x_request_id;
  proxy_set_header    X-Forwarded-Host    $host;

  include /etc/nginx/app.conf;

  server {
    listen 18081 default_server;

    access_log off;
    keepalive_timeout 0;

    location /healthz {
      return 200;
    }

    location /metrics {
      wallarm_status on format=prometheus;
    }

    location /wallarm-status {
      wallarm_status on format=json;
    }
  }
}
